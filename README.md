\# STM32 Modular ADC Project



\## 📌 Overview

This project implements a \*\*modular firmware framework for STM32 microcontrollers\*\* (tested on STM32F303 Discovery and STM32H533 Nucleo).  

The main goal is to provide a clean, scalable design for:

\- \*\*Multi-ADC management\*\* (e.g. LTC2368 devices),

\- \*\*Command \& control via USB CDC\*\* (emulated UART, AT-style interface),

\- \*\*Efficient data flow using ring buffers\*\*,

\- \*\*Modular architecture\*\* that separates hardware drivers, middleware, and application logic.



---



\## 🏗️ Architecture



\### 🔹 Core Modules

\- \*\*`adc\_mgr`\*\*  

&nbsp; Manages multiple ADC devices, their configurations and conversions.  

&nbsp; Interfaces with hardware drivers (SPI, GPIO BUSY pin) and higher-level command handlers.



\- \*\*`ringbuffer`\*\*  

&nbsp; Lightweight, lock-free ring buffer implementation.  

&nbsp; - Supports both \*\*8-bit\*\* (for communication) and \*\*16-bit\*\* (for ADC samples).  

&nbsp; - Implements the “one slot free” convention for distinguishing `FULL` vs `EMPTY`.



\- \*\*`at\_parser`\*\*  

&nbsp; Simple and extensible AT-style command parser.  

&nbsp; - Supports registering commands with callbacks.  

&nbsp; - Provides `AT\_OK`, `AT\_ERROR`, `AT\_BUSY`, etc.  

&nbsp; - Designed to work with any transport (USB CDC, UART, etc.) via a user-provided \*\*writer function\*\*.



\- \*\*`usb\_cdc\_if`\*\*  

&nbsp; USB CDC transport layer (generated by CubeMX).  

&nbsp; - RX: packets are pushed directly into `ringbuffer` in the `CDC\_Receive\_FS` callback.  

&nbsp; - TX: commands and responses use a TX queue with periodic flushing (to handle `USBD\_BUSY`).



\### 🔹 Application Layer

\- \*\*`main.c`\*\*  

&nbsp; Initializes peripherals (USB, SPI, timers).  

&nbsp; Creates and registers ADC handlers.  

&nbsp; Runs main loop:

&nbsp; - Polls RX ring buffer → assembles lines → feeds into AT parser,

&nbsp; - Flushes USB TX queue,

&nbsp; - Manages background tasks (e.g. ADC sampling, status reporting).



---



\## ⚙️ Project Structure



Core/

├── Inc/

│ ├── adc\_mgr.h

│ ├── at\_parser.h

│ ├── ringbuffer.h

│ ├── usb\_if.h

│ └── main.h

└── Src/

├── adc\_mgr.c

├── at\_parser.c

├── ringbuffer.c

├── usb\_if.c (wrapper over usbd\_cdc\_if.c)

└── main.c



\## 🔌 Data Flow

USB CDC | RX Packet | ----> | RingBuffer | ----> | AT Parser |

+-------------+ +-------------+ +----------------+

|

v

+-----------+

| Commands |

| (ADC, |

| Tests) |

+-----------+



ADC (SPI + BUSY pin) ---> RingBuffer16 ---> Host (USB CDC TX)





---



\## 🖥️ Example AT Commands



\- `AT` → respond with `OK`.  

\- `AT+HELP` → list available commands.  

\- `AT+ADCSTART=0` → start conversion on ADC0.  

\- `AT+ADCSTOP=1` → stop conversion on ADC1.  

\- `AT+STATUS` → return system state (busy flags, errors).



---



\## 🔒 Design Choices



\- \*\*Struct-in-struct vs pointers\*\*:  

&nbsp; - Use \*\*composition\*\* (`struct inside struct`) for integral parts (e.g. `GPIO\_Assignment busy\_gpio`).  

&nbsp; - Use \*\*pointers\*\* for shared/external resources (e.g. `SPI\_HandleTypeDef \*`).



\- \*\*Buffers inside structs\*\*:  

&nbsp; - `uint8\_t buf\[N]` inside struct → allocated automatically with the struct.  

&nbsp; - `uint8\_t \*buf` → only pointer, must be assigned manually.



\- \*\*USB CDC\*\*:  

&nbsp; - RX: always copy packet into our ring buffer in ISR context, never parse in callback.  

&nbsp; - TX: always check for `USBD\_BUSY`, queue pending packets, flush at SOF (1 kHz).



---



\## 📊 Future Work

\- Add DMA-based ADC → USB CDC streaming (zero-copy pipeline).  

\- Implement error handling for ADC BUSY pin timeouts.  

\- Add configuration persistence (store settings in Flash).  

\- Expand AT command set (self-tests, error reporting, data logging).  



---



\## 🛠️ Development Notes

\- Written in \*\*C99\*\*, using \*\*STM32 HAL\*\* and \*\*CubeMX generated boilerplate\*\*.  

\- Parser designed to be transport-independent (can be reused with UART, CAN, etc.).  

\- Ring buffer supports \*\*bulk writes\*\* for performance (USB packet-sized copies).  

\- Compatible with \*\*STM32F3\*\* and \*\*STM32H5\*\* families.



---



\## 📚 References

\- \[STM32Cube USB Device CDC Application](https://wiki.st.com/stm32mcu/wiki/Connectivity:USB\_device\_CDC)  

\- \[ST RM0316 Reference Manual (STM32F3)](https://www.st.com/resource/en/reference\_manual/dm00043574.pdf)  

\- \[LTC2368 Datasheet](https://www.analog.com/media/en/technical-documentation/data-sheets/2368fc.pdf)  









